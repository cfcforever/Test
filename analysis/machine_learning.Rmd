---
title: "Machine learning method"
# author: "cfcforever"
# date: ""
output: 
  workflowr::wflow_html:
    code_folding: hide
editor_options:
  chunk_output_type: console
---

We are using the machine learning method to stabilize the points.

```{r include=FALSE}
source("code/packages_and_functions.R")
```


# Introduction
This is an example of 199 points with the frequency of 200ms. 
We want to use a machine learning model to recognize if any 5 consecutive points are moving or not. 

```{r}
# load json file
json_data <- fromJSON(file = "data/Stabiliseur/data/2021-02-12_Firminy/test1/t1_anchor1_3tags_200ms.json")

# choose tagId, x and y from json_data, and convert list to data.frame
data <- data.frame(tagId = unlist(lapply(json_data, function(x){x$tagId})),
                   x = unlist(lapply(json_data, function(x){as.numeric(x$posUnfiltered$x)})),
                   y = unlist(lapply(json_data, function(x){as.numeric(x$posUnfiltered$y)})))

# choose a tag
dd = data %>%
  filter(tagId == "82a5")
```

## plot of data
```{r}
p <- ggplot(dd) + theme_bw() +
  geom_point(aes(x=x, y=y), col="red") + 
  coord_equal(ratio = 1)
print(p)
```


# Machine learning method with 10 consecutive points
## load model and predict data
```{r}
load("data/Stabiliseur/ML/ML_model_with_10_points.RData")

input = as.data.frame(matrix(NA, nrow = nrow(dd)-9, ncol = 45))
for (k in 1:nrow(input)){
  input[k,] = as.numeric(dist(dd[k:(k+9), c("x","y")]))
}

dd$pred = 0
prediction = round(predict(ir, input), 3)
dd$pred[1:nrow(input)] = prediction

datatable(dd, class = 'cell-border stripe')
```


## result
```{r}
nb = length(prediction)
num = sum(prediction<=0.7)
ratio = num/nb
message(paste0(unique(dd$tagId), " - with ", nb, " points and to be predicted ", ratio*100, "% corrected of resting positions (which ", nb-num, " points are false)."))
```


## Study cases{.tabset .tabset-pills}
### case 1
```{r}
k = 57
dk = 9

dist = round(as.matrix(dist(dd[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=dd[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=dd[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=dd[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(dd$x), ylim = range(dd$y))
p
```


### case 2
```{r}
k = 88
dk = 9

dist = round(as.matrix(dist(dd[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=dd[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=dd[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=dd[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(dd$x), ylim = range(dd$y))
p
```



# Machine learning method with 5 consecutive points
## load model and predict data
```{r}
load("data/Stabiliseur/ML/ML_model.RData")

input = as.data.frame(matrix(NA, nrow = nrow(dd)-4, ncol = 10))
for (k in 1:nrow(input)){
  input[k,] = as.numeric(dist(dd[k:(k+4), c("x","y")]))
}

dd$pred = 0
prediction = round(predict(ir, input), 3)
dd$pred[1:nrow(input)] = prediction

datatable(dd, class = 'cell-border stripe')
```


## result
```{r}
nb = length(prediction)
num = sum(prediction<=0.5)
ratio = num/nb
message(paste0(unique(dd$tagId), " - with ", nb, " points and to be predicted ", ratio*100, "% corrected of resting positions (which ", nb-num, " points are false)."))
```


## Study cases{.tabset .tabset-pills}
### case 1
```{r}
k = 42
dk = 4

dist = round(as.matrix(dist(dd[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=dd[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=dd[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=dd[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(dd$x), ylim = range(dd$y))
p
```


### case 2
```{r}
k = 61
dk = 7

dist = round(as.matrix(dist(dd[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=dd[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=dd[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=dd[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(dd$x), ylim = range(dd$y))
p
```


### case 3
```{r}
k = 71
dk = 5

dist = round(as.matrix(dist(dd[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=dd[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=dd[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=dd[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(dd$x), ylim = range(dd$y))
p
```


### case 4
```{r}
k = 75
dk = 4

dist = round(as.matrix(dist(dd[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=dd[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=dd[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=dd[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(dd$x), ylim = range(dd$y))
p
```


### case 5
```{r}
k = 79
dk = 4

dist = round(as.matrix(dist(dd[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=dd[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=dd[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=dd[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(dd$x), ylim = range(dd$y))
p
```


### case 6
```{r}
k = 81
dk = 4

dist = round(as.matrix(dist(dd[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=dd[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=dd[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=dd[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(dd$x), ylim = range(dd$y))
p
```


### case 7
```{r}
k = 88
dk = 4

dist = round(as.matrix(dist(dd[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=dd[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=dd[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=dd[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(dd$x), ylim = range(dd$y))
p
```


### case 8
```{r}
k = 94
dk = 6

dist = round(as.matrix(dist(dd[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=dd[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=dd[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=dd[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(dd$x), ylim = range(dd$y))
p
```


# Validation with data of Firminy
```{r}
load("data/Stabiliseur/ML/ML_model_with_10_points.RData")
```

## fixed tag
We are using the FIX (19ab) tag to valide the machine learning model when it's still.

```{r eval=FALSE, include=FALSE}
data_tag <- read.csv2("data/json/2021-10-31/19ab.csv")
data_tag$timediff = c(data_tag$timediff[-1],0)
data_tag$consec = NA
data_tag$stab = NA
for (k in 1:(nrow(data_tag)-9)){
  td = data_tag$timediff[k:(k+9)]
  if (all(td>=0.19) & all(td<=0.21)){
    data_tag$consec[k] = T
    temp = as.numeric(dist(data_tag[k:(k+9), c("x","y")]))
    data_tag$stab[k] = predict(ir, temp)
  }else{
    data_tag$consec[k] = F
  }
}
# save(data_tag, file = "data/Stabiliseur/output/19ab_20211031.RData")
```

```{r}
load("data/Stabiliseur/output/19ab_20211031.RData")

nb_all = sum(data_tag$consec, na.rm = T)
nb_fix = sum(data_tag$stab<=0.5, na.rm = T)
nb_mov = nb_all - nb_fix

cat("number of points to validate:", nb_all, "\n")

cat("number of points to consider as fixed:", nb_fix, "which presents", 
    nb_fix, "/", nb_all, "=", round(nb_fix/nb_all*100, 2), "% of all points", "\n")

cat("number of points to consider as moving:", nb_fix, "which presents", 
    nb_mov, "/", nb_all, "=", round(nb_mov/nb_all*100, 2), "% of all points", "\n")
```

### study cases{.tabset .tabset-pills}
#### case 1
```{r}
k = order(data_tag$stab, decreasing = T)[1]
dk = 9

cat("the point", k, "is moving with confidence", data_tag$stab[k], "\n")

dist = round(as.matrix(dist(data_tag[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=data_tag[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=data_tag[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=data_tag[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(data_tag$x), ylim = range(data_tag$y))
p
```


#### case 2
```{r}
k = order(data_tag$stab, decreasing = T)[2]
dk = 9

cat("the point", k, "is moving with confidence", data_tag$stab[k], "\n")

dist = round(as.matrix(dist(data_tag[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=data_tag[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=data_tag[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=data_tag[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(data_tag$x), ylim = range(data_tag$y))
p
```


#### case 3
```{r}
k = order(data_tag$stab, decreasing = T)[3]
dk = 9

cat("the point", k, "is moving with confidence", data_tag$stab[k], "\n")

dist = round(as.matrix(dist(data_tag[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=data_tag[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=data_tag[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=data_tag[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(data_tag$x), ylim = range(data_tag$y))
p
```


#### case 4
```{r}
k = order(data_tag$stab, decreasing = T)[8]
dk = 9

cat("the point", k, "is moving with confidence", data_tag$stab[k], "\n")

dist = round(as.matrix(dist(data_tag[k:(k+dk),c("x","y")])), 3)
kable(dist) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

p <- ggplot() + theme_bw() +
  geom_point(data=data_tag[k:(k+dk),], aes(x=x, y=y), col="red") + 
  geom_text(data=data_tag[k:(k+dk),], aes(x=x, y=y, label=k:(k+dk), vjust=-0.5), size=3) + 
  geom_path(data=data_tag[k:(k+dk),], aes(x=x,y=y), col="red") + 
  coord_equal(ratio = 1, xlim = range(data_tag$x), ylim = range(data_tag$y))
p
```
